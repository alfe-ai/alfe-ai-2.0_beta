<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Task Queue</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>

<div class="app">
  <aside class="sidebar">
    <h2 style="font-size:1.2rem; margin-top:0;">Tasks</h2>

    <!-- Collapsible toolbar, so it doesn't clutter the top row constantly -->
    <details id="toolbarCollapsible">
      <summary>Toolbar & Filters</summary>
      <div id="controls">
        <label><input type="checkbox" id="showHidden" /> Show hidden tasks</label>
        <label style="margin-left:1rem;">Project:
          <select id="projectFilter"><option value="">All projects</option></select>
        </label>
        <label style="margin-left:1rem;">Sprint:
          <select id="sprintFilter"><option value="">All sprints</option></select>
        </label>
        <button id="addTaskBtn" style="margin-top:4px;">‚ûï New Task</button>
        <button id="instrBtn" title="Agent instructions">üìù</button>
        <button id="gearBtn" title="Configure columns">‚öôÔ∏è</button>
        <button id="defaultsBtn" title="Default project/sprint">‚≠ê</button>
        <button id="repoBtn" title="Edit Git repository">üîÄ</button>
        <button id="toggleTasksBtn">Hide tasks</button>
      </div>
    </details>

    <table id="tasks">
      <thead><tr id="headerRow"></tr></thead>
      <tbody></tbody>
    </table>
  </aside>

  <!-- Draggable divider -->
  <div id="divider" class="divider"></div>

  <main class="chat-panel">
    <!-- Chat tabs area -->
    <div id="chatTabs" style="display:flex; gap:0.5rem; align-items:center; margin-bottom:8px;">
      <div id="tabsContainer" style="flex-wrap: wrap; display: flex; gap: 0.5rem;"></div>
      <button id="newTabBtn">‚ûï Tab</button>
    </div>

    <!-- Collapsible section to display agent instructions (collapsed by default) -->
    <div style="margin: 8px 0;">
      <details style="max-width: 600px;" id="instructionsCollapse">
        <summary>Agent Instructions (click to expand)</summary>
        <pre id="displayedInstructions"></pre>
      </details>
    </div>

    <div id="chatPanel" style="position: relative;">
      <div style="display: flex; align-items: center; gap: 0.5rem;">
        <!-- Model HUD -->
        <div id="modelHud" style="font-size:0.9rem; color:#aaa; margin-bottom:4px;"></div>
        <!-- Chat Settings gear -->
        <button id="chatSettingsBtn" title="Chat Settings">‚öôÔ∏è</button>
      </div>

      <div id="chatMessages"></div>
      <!-- Scroll down button -->
      <button id="scrollDownBtn">Scroll to Bottom</button>

      <div id="waitingCounter"></div>
      <div class="chat-input-container">
        <textarea id="chatInput" placeholder="Type your message..."></textarea>
        <button id="chatSendBtn" class="send-btn">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
               stroke-linecap="round" stroke-linejoin="round" class="feather feather-send">
            <line x1="22" y1="2" x2="11" y2="13"></line>
            <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
          </svg>
        </button>
      </div>
    </div>
  </main>
</div>

<!-- Column picker modal -->
<div id="colModal" class="modal">
  <div class="modal-content">
    <h2>Columns</h2>
    <div id="colList"></div>
    <div class="modal-buttons">
      <button id="colSaveBtn">Save</button>
      <button id="colCancelBtn">Cancel</button>
    </div>
  </div>
</div>

<!-- Agent instructions modal (for editing) -->
<div id="instrModal" class="modal">
  <div class="modal-content">
    <h2>Agent Instructions</h2>
    <label>Agent Name:
      <input type="text" id="agentNameInput" style="width:100%;" />
    </label>
    <br/><br/>
    <label>Instructions:<br/>
      <textarea id="instrText" rows="10" style="width:100%;"></textarea>
    </label>
    <div class="modal-buttons">
      <button id="instrSaveBtn">Save</button>
      <button id="instrCancelBtn">Cancel</button>
    </div>
  </div>
</div>

<!-- Git repo modal -->
<div id="repoModal" class="modal">
  <div class="modal-content">
    <h2>Edit Git repository</h2>
    <label>Repository (owner/repo):
      <input type="text" id="repoInput" style="width:100%;" />
    </label>
    <div class="modal-buttons">
      <button id="repoSaveBtn">Save</button>
      <button id="repoCancelBtn">Cancel</button>
    </div>
  </div>
</div>

<!-- Defaults modal -->
<div id="defaultsModal" class="modal">
  <div class="modal-content">
    <h2>Default project / sprint</h2>
    <label>Default project:
      <input type="text" id="defProjectInput" style="width:100%;" />
    </label>
    <label>Default sprint:
      <input type="text" id="defSprintInput" style="width:100%;" />
    </label>
    <div class="modal-buttons">
      <button id="defSaveBtn">Save</button>
      <button id="defCancelBtn">Cancel</button>
    </div>
  </div>
</div>

<!-- New Task modal -->
<div id="newTaskModal" class="modal">
  <div class="modal-content">
    <h2>Create New Task</h2>
    <label>Title:<br/>
      <input type="text" id="newTaskTitle" style="width:100%;" />
    </label>
    <label style="margin-top:8px;">Description:<br/>
      <textarea id="newTaskBody" rows="5" style="width:100%;"></textarea>
    </label>
    <div class="modal-buttons">
      <button id="createTaskBtn">Create</button>
      <button id="cancelTaskBtn">Cancel</button>
    </div>
  </div>
</div>

<!-- Chat Settings Modal -->
<div id="chatSettingsModal" class="modal">
  <div class="modal-content">
    <h2>Chat Settings</h2>
    <label><input type="checkbox" id="hideMetadataCheck" /> Hide metadata expansions</label>
    <div class="modal-buttons">
      <button id="chatSettingsSaveBtn">Save</button>
      <button id="chatSettingsCancelBtn">Cancel</button>
    </div>
  </div>
</div>

<script>
  /* ---------------- default column definitions ---------------- */
  let columnsOrder = [
    { key: "drag",         label: "‚†ø"          },
    { key: "priority",     label: "Prio"       },
    { key: "status",       label: "Status"     },
    { key: "number",       label: "#"          },
    { key: "title",        label: "Title"      },
    { key: "dependencies", label: "Depends On" },
    { key: "project",      label: "Project"    },
    { key: "created",      label: "Created"    }
  ];
  let visibleCols = new Set(columnsOrder.map(c => c.key));
  let allTasks = [];
  let dragSrcRow = null;
  let modelName = "unknown";
  let tasksVisible = true;
  let chatTabs = [];
  let currentTabId = 1;
  let chatHideMetadata = false;
  window.agentName = "Alfe AI"; // default, replaced by DB setting if found

  const $  = (sel, ctx=document) => ctx.querySelector(sel);
  const $$ = (sel, ctx=document) => [...ctx.querySelectorAll(sel)];

  function formatTimestamp(isoStr){
    if(!isoStr) return "(no time)";
    const d = new Date(isoStr);
    return d.toLocaleTimeString([], {
      hour12: true,
      hour: '2-digit',
      minute: '2-digit',
      second: '2-digit'
    });
  }

  function isoDate(d) {
    return new Date(d).toLocaleDateString([], {
      year:"numeric",
      month:"2-digit",
      day:"2-digit"
    });
  }

  function showModal(m){ m.style.display = "flex"; }
  function hideModal(m){ m.style.display = "none"; }
  $$(".modal").forEach(m => m.addEventListener("click", e => { if(e.target===m) hideModal(m); }));

  /* ------------------------------------------------------------------
   * Toggling the task table
   * ------------------------------------------------------------------ */
  async function toggleTasks(){
    tasksVisible = !tasksVisible;
    $("#tasks").style.display = tasksVisible ? "" : "none";
    $("#toggleTasksBtn").textContent = tasksVisible ? "Hide tasks" : "Show tasks";
    // Save the setting
    await fetch("/api/settings", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ key: "tasks_visible", value: tasksVisible })
    });
  }
  $("#toggleTasksBtn").addEventListener("click", toggleTasks);

  /* ------------------------------------------------------------------
   * Load & save column config
   * ------------------------------------------------------------------ */
  async function loadSettings(){
    {
      const r = await fetch("/api/settings/visible_columns");
      if(r.ok){
        const { value } = await r.json();
        if(Array.isArray(value)){ visibleCols = new Set(value); }
      }
    }
    {
      const r = await fetch("/api/settings/columns_order");
      if(r.ok){
        const { value } = await r.json();
        if(Array.isArray(value)){
          const map = Object.fromEntries(columnsOrder.map(c=>[c.key,c]));
          const newOrd = [];
          value.forEach(k => { if(map[k]){ newOrd.push(map[k]); delete map[k]; }});
          Object.values(map).forEach(c => newOrd.push(c));
          columnsOrder = newOrd;
        }
      }
    }
    {
      const r = await fetch("/api/settings/tasks_visible");
      if(r.ok){
        const { value } = await r.json();
        if(typeof value !== "undefined"){
          tasksVisible = !!value;
        }
      }
      $("#tasks").style.display = tasksVisible ? "" : "none";
      $("#toggleTasksBtn").textContent = tasksVisible ? "Hide tasks" : "Show tasks";
    }
  }
  async function saveSettings(){
    await fetch("/api/settings",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({ key:"visible_columns", value:[...visibleCols] })
    });
    await fetch("/api/settings",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({ key:"columns_order", value:columnsOrder.map(c=>c.key) })
    });
  }

  function renderHeader(){
    const tr = $("#headerRow");
    tr.innerHTML = "";
    columnsOrder.forEach(col => {
      if(!visibleCols.has(col.key)) return;
      const th = document.createElement("th");
      th.textContent = col.label;
      tr.appendChild(th);
    });
  }

  /* ------------------------------------------------------------------
   * Drag & drop reordering
   * ------------------------------------------------------------------ */
  function handleDragStart(e){
    dragSrcRow = e.target.closest("tr");
    e.dataTransfer.effectAllowed = "move";
  }
  function handleDragOver(e){
    if(dragSrcRow && e.currentTarget !== dragSrcRow){
      e.preventDefault();
      e.dataTransfer.dropEffect = "move";
      e.currentTarget.classList.add("drag-over");
    }
  }
  function handleDragLeave(e){
    e.currentTarget.classList.remove("drag-over");
  }
  function handleDrop(e){
    e.preventDefault();
    const target = e.currentTarget;
    target.classList.remove("drag-over");
    if(dragSrcRow && dragSrcRow !== target){
      const tbody = target.parentNode;
      const rows = [...tbody.children];
      let from = rows.indexOf(dragSrcRow);
      let to = rows.indexOf(target);
      tbody.removeChild(dragSrcRow);
      if(from < to) to--;
      tbody.insertBefore(dragSrcRow, tbody.children[to]);
      saveNewOrderToServer();
    }
    dragSrcRow = null;
  }
  function handleDragEnd(){
    $$(`tr.drag-over`).forEach(r=>r.classList.remove("drag-over"));
    dragSrcRow = null;
  }
  async function saveNewOrderToServer(){
    const ids = $$("#tasks tbody tr").map(r=>+r.dataset.taskId);
    await fetch("/api/tasks/reorderAll",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({ orderedIds: ids })
    });
  }

  async function fetchTasks(){
    const inc = $("#showHidden").checked;
    const res = await fetch(`/api/tasks?includeHidden=${inc?1:0}`);
    return res.json();
  }

  function renderBody(){
    const tbody = $("#tasks tbody");
    tbody.innerHTML = "";
    const pj = $("#projectFilter").value;
    const sp = $("#sprintFilter").value;
    allTasks
            .filter(t=>{
              if(pj && t.project!==pj) return false;
              if(sp && t.sprint!==sp) return false;
              return true;
            })
            .forEach(t=>{
              const tr = document.createElement("tr");
              tr.dataset.taskId = t.id;
              if(t.hidden) tr.classList.add("hidden");
              [
                "drag","priority","status","number","title",
                "dependencies","project","created"
              ].forEach(key=>{
                if(!visibleCols.has(key)) return;
                const td = document.createElement("td");
                switch(key){
                  case "drag":
                    td.innerHTML = `<span class="drag-handle" draggable="true">‚†ø</span>`;
                    td.querySelector(".drag-handle").addEventListener("dragstart", handleDragStart);
                    break;
                  case "priority":
                    td.textContent = t.priority;
                    td.className="priority-cell";
                    break;
                  case "status":
                    td.textContent = t.status;
                    td.className="status-cell";
                    break;
                  case "number":
                    td.innerHTML = `<a href="${t.html_url}" target="_blank">#${t.number}</a>`;
                    break;
                  case "title":
                    td.textContent = t.title;
                    td.className="title-cell";
                    break;
                  case "dependencies":
                    td.textContent = t.dependencies;
                    td.className="dependencies-cell";
                    break;
                  case "project":
                    td.textContent = t.project;
                    td.className="project-cell";
                    break;
                  case "created":
                    td.textContent = isoDate(t.created_at);
                    break;
                  default:
                    td.textContent = t[key]||"";
                }
                tr.appendChild(td);
              });
              ["dragover","dragleave","drop","dragend"].forEach(evt=>{
                tr.addEventListener(evt, {
                  "dragover":handleDragOver,
                  "dragleave":handleDragLeave,
                  "drop":handleDrop,
                  "dragend":handleDragEnd
                }[evt]);
              });
              tbody.appendChild(tr);
            });
  }

  async function loadTasks(){
    allTasks = await fetchTasks();
    renderHeader();
    renderBody();
  }

  /* Filter logic */
  async function populateFilters(){
    const pj = await (await fetch("/api/projects")).json();
    $("#projectFilter").innerHTML = '<option value="">All projects</option>' +
            pj.map(p=>`<option value="${p.project}">${p.project}</option>`).join("");
    const sp = await (await fetch("/api/sprints")).json();
    $("#sprintFilter").innerHTML = '<option value="">All sprints</option>' +
            sp.map(s=>`<option value="${s.sprint}">${s.sprint}</option>`).join("");
  }

  function openColModal(){
    const cnt = $("#colList");
    cnt.innerHTML="";
    columnsOrder.forEach((c,i)=>{
      const div = document.createElement("div");
      div.className="col-item";
      div.innerHTML = `<button class="col-move" data-idx="${i}" data-dir="up">‚¨ÜÔ∏è</button>` +
              `<button class="col-move" data-idx="${i}" data-dir="down">‚¨áÔ∏è</button>` +
              `<label><input type="checkbox" value="${c.key}" ${visibleCols.has(c.key)?"checked":""}/> ${c.label||c.key}</label>`;
      cnt.appendChild(div);
    });
    showModal($("#colModal"));
  }
  $("#gearBtn").addEventListener("click", openColModal);
  $("#colList").addEventListener("click", e=>{
    if(!e.target.classList.contains("col-move")) return;
    const i = +e.target.dataset.idx, d=e.target.dataset.dir;
    const ni = d==="up"?i-1:i+1;
    if(ni<0||ni>=columnsOrder.length) return;
    [columnsOrder[i],columnsOrder[ni]]=[columnsOrder[ni],columnsOrder[i]];
    openColModal();
  });
  $("#colSaveBtn").addEventListener("click", async ()=>{
    visibleCols.clear();
    $$("#colList input[type=checkbox]").forEach(cb=>{
      if(cb.checked) visibleCols.add(cb.value);
    });
    await saveSettings();
    hideModal($("#colModal"));
    await loadTasks();
  });
  $("#colCancelBtn").addEventListener("click",()=>hideModal($("#colModal")));

  $("#tasks").addEventListener("click", async e=>{
    const btn = e.target.closest("button");
    if(btn){
      if(btn.classList.contains("eye")){
        const id=+btn.dataset.id;
        const hideNow=btn.textContent==="üëÅÔ∏è";
        await fetch("/api/tasks/hidden",{
          method:"POST",
          headers:{"Content-Type":"application/json"},
          body:JSON.stringify({id,hidden:hideNow})
        });
        return loadTasks();
      }
      if(btn.classList.contains("arrow")){
        const id=+btn.dataset.id, dir=btn.dataset.dir;
        await fetch("/api/tasks/reorder",{
          method:"POST",
          headers:{"Content-Type":"application/json"},
          body:JSON.stringify({id,direction:dir})
        });
        return loadTasks();
      }
    }
    const cell = e.target;
    const row = cell.closest("tr");
    if(!row) return;
    const taskId=+row.dataset.taskId;

    function inlineEdit(newEl, saveCb){
      cell.textContent="";
      cell.appendChild(newEl);
      newEl.focus();
      newEl.addEventListener("change", async ()=>{
        await saveCb(newEl.value);
        await loadTasks();
      });
      newEl.addEventListener("blur", ()=>loadTasks());
    }

    if(cell.classList.contains("priority-cell")){
      const sel = document.createElement("select");
      ["Low","Medium","High"].forEach(v=>{
        const o=document.createElement("option");
        o.value=v; o.textContent=v;
        if(v===cell.textContent) o.selected=true;
        sel.appendChild(o);
      });
      return inlineEdit(sel,v=>fetch("/api/tasks/priority",{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({id:taskId,priority:v})
      }));
    }
    if(cell.classList.contains("status-cell")){
      const sel=document.createElement("select");
      ["Not Started","In Progress","Done"].forEach(v=>{
        const o=document.createElement("option");
        o.value=v; o.textContent=v;
        if(v===cell.textContent) o.selected=true;
        sel.appendChild(o);
      });
      return inlineEdit(sel,v=>fetch("/api/tasks/status",{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({id:taskId,status:v})
      }));
    }
    if(cell.classList.contains("project-cell")){
      const inp=document.createElement("input");
      inp.type="text";
      inp.value=cell.textContent;
      return inlineEdit(inp,v=>fetch("/api/tasks/project",{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({id:taskId,project:v})
      }));
    }
    if(cell.classList.contains("dependencies-cell")){
      const inp=document.createElement("input");
      inp.type="text";
      inp.value=cell.textContent;
      return inlineEdit(inp,v=>fetch("/api/tasks/dependencies",{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({id:taskId,dependencies:v})
      }));
    }
    if(cell.classList.contains("title-cell")){
      const inp=document.createElement("input");
      inp.type="text";
      inp.value=cell.textContent;
      return inlineEdit(inp,v=>fetch("/api/tasks/rename",{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({id:taskId,newTitle:v})
      }));
    }
  });

  $("#showHidden").addEventListener("change", loadTasks);
  $("#projectFilter").addEventListener("change", renderBody);
  $("#sprintFilter").addEventListener("change", renderBody);

  $("#instrBtn").addEventListener("click", async ()=>{
    {
      const r=await fetch("/api/settings/agent_instructions");
      if(r.ok){
        const {value}=await r.json();
        $("#instrText").value=value||"";
      }
    }
    {
      const r2=await fetch("/api/settings/agent_name");
      if(r2.ok){
        const {value}=await r2.json();
        $("#agentNameInput").value=value||"";
      }
    }
    showModal($("#instrModal"));
  });
  $("#instrSaveBtn").addEventListener("click", async ()=>{
    await fetch("/api/settings",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({key:"agent_instructions",value:$("#instrText").value})
    });
    await fetch("/api/settings",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({key:"agent_name",value:$("#agentNameInput").value})
    });
    hideModal($("#instrModal"));
  });
  $("#instrCancelBtn").addEventListener("click",()=>hideModal($("#instrModal")));

  $("#repoBtn").addEventListener("click", async ()=>{
    const r=await fetch("/api/settings/github_repo");
    if(r.ok){
      const {value}=await r.json();
      $("#repoInput").value=value||"";
    }
    showModal($("#repoModal"));
  });
  $("#repoSaveBtn").addEventListener("click", async ()=>{
    await fetch("/api/settings",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({key:"github_repo",value:$("#repoInput").value})
    });
    hideModal($("#repoModal"));
  });
  $("#repoCancelBtn").addEventListener("click",()=>hideModal($("#repoModal")));

  $("#defaultsBtn").addEventListener("click", async ()=>{
    let r=await fetch("/api/settings/default_project");
    if(r.ok){
      const{value}=await r.json();
      $("#defProjectInput").value=value||"";
    }
    r=await fetch("/api/settings/default_sprint");
    if(r.ok){
      const{value}=await r.json();
      $("#defSprintInput").value=value||"";
    }
    showModal($("#defaultsModal"));
  });
  $("#defSaveBtn").addEventListener("click", async ()=>{
    await fetch("/api/settings",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({key:"default_project",value:$("#defProjectInput").value})
    });
    await fetch("/api/settings",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({key:"default_sprint",value:$("#defSprintInput").value})
    });
    hideModal($("#defaultsModal"));
  });
  $("#defCancelBtn").addEventListener("click",()=>hideModal($("#defaultsModal")));

  $("#addTaskBtn").addEventListener("click",()=>{
    $("#newTaskTitle").value="";
    $("#newTaskBody").value="";
    showModal($("#newTaskModal"));
  });
  $("#createTaskBtn").addEventListener("click", async ()=>{
    const title=$("#newTaskTitle").value.trim(),
            body=$("#newTaskBody").value.trim();
    if(!title){
      alert("Please enter a title for the new task.");
      return;
    }
    const res=await fetch("/api/tasks/new",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({title,body})
    });
    if(!res.ok){
      alert("Error creating task. Check console/logs.");
      return;
    }
    hideModal($("#newTaskModal"));
    await loadTasks();
  });
  $("#cancelTaskBtn").addEventListener("click",()=>hideModal($("#newTaskModal")));

  /* ------------------------------------------------------------------
   * Chat tab logic
   * ------------------------------------------------------------------ */
  async function loadTabs(){
    const res = await fetch("/api/chat/tabs");
    chatTabs = await res.json();
  }
  async function addNewTab(){
    const name = prompt("Enter tab name:", "New Tab");
    if(!name) return;
    const r = await fetch("/api/chat/tabs/new", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ name })
    });
    if(r.ok){
      await loadTabs();
      renderTabs();
    }
  }
  async function renameTab(tabId){
    const t = chatTabs.find(t => t.id===tabId);
    const newName = prompt("Enter new tab name:", t ? t.name : "Untitled");
    if(!newName) return;
    const r = await fetch("/api/chat/tabs/rename", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ tabId, newName })
    });
    if(r.ok){
      await loadTabs();
      renderTabs();
    }
  }
  async function deleteTab(tabId){
    if(!confirm("Are you sure you want to delete this tab (and all its messages)?")) return;
    const r = await fetch(`/api/chat/tabs/${tabId}`, { method: "DELETE" });
    if(r.ok){
      await loadTabs();
      if(chatTabs.length>0){
        currentTabId = chatTabs[0].id;
      } else {
        currentTabId=1;
      }
      renderTabs();
      await loadChatHistory(currentTabId);
    }
  }
  function selectTab(tabId){
    currentTabId = tabId;
    loadChatHistory(tabId);
    renderTabs();
  }
  function renderTabs(){
    const tc = $("#tabsContainer");
    tc.innerHTML="";
    chatTabs.forEach(tab => {
      const tabBtn = document.createElement("div");
      tabBtn.style.display="flex";
      tabBtn.style.alignItems="center";
      tabBtn.style.border="1px solid #444";
      tabBtn.style.padding="4px 6px";
      tabBtn.style.cursor="pointer";
      tabBtn.style.backgroundColor = (tab.id===currentTabId) ? "#444" : "#333";
      tabBtn.style.color = "#ddd";
      tabBtn.textContent = tab.name;
      tabBtn.addEventListener("click", ()=>selectTab(tab.id));

      tabBtn.addEventListener("contextmenu", e=>{
        e.preventDefault();
        const choice = prompt("Type 'rename' or 'delete':", "");
        if(choice==="rename") renameTab(tab.id);
        else if(choice==="delete") deleteTab(tab.id);
      });
      tc.appendChild(tabBtn);
    });
  }
  $("#newTabBtn").addEventListener("click", addNewTab);

  /* ------------------------------------------------------------------
   * Add chat messages
   * ------------------------------------------------------------------ */
  function addChatMessage(pairId, userText, userTs, aiText, aiTs, model, systemContext, fullHistory) {
    const seqDiv = document.createElement("div");
    seqDiv.className = "chat-sequence";

    /* User bubble */
    const userDiv = document.createElement("div");
    userDiv.className = "chat-user";
    {
      const userHead = document.createElement("div");
      userHead.className = "bubble-header";
      userHead.innerHTML = `
        <div class="name-oval name-oval-user">User</div>
        <span style="opacity:0.8;">${formatTimestamp(userTs)}</span>
      `;
      userDiv.appendChild(userHead);

      const userBody = document.createElement("div");
      userBody.textContent = userText;
      userDiv.appendChild(userBody);
    }
    seqDiv.appendChild(userDiv);

    /* AI bubble */
    const botDiv = document.createElement("div");
    botDiv.className = "chat-bot";
    {
      const botHead = document.createElement("div");
      botHead.className = "bubble-header";
      botHead.innerHTML = `
        <div class="name-oval name-oval-ai">${window.agentName}</div>
        <span style="opacity:0.8;">${aiTs ? formatTimestamp(aiTs) : "‚Ä¶"}</span>
      `;
      botDiv.appendChild(botHead);

      const botBody = document.createElement("div");
      botBody.textContent = aiText || "";
      botDiv.appendChild(botBody);
    }
    seqDiv.appendChild(botDiv);

    if(!chatHideMetadata){
      const metaContainer = document.createElement("div");
      metaContainer.style.fontSize = "0.8rem";
      metaContainer.style.color = "#aaa";
      metaContainer.style.textAlign = "right";

      const pairLabel = document.createElement("div");
      pairLabel.textContent = `Pair #${pairId}`;
      metaContainer.appendChild(pairLabel);

      if(model) {
        const modelLabel = document.createElement("div");
        modelLabel.textContent = `Model: ${model}`;
        metaContainer.appendChild(modelLabel);
      }

      if(systemContext) {
        const scDetails = document.createElement("details");
        const scSum = document.createElement("summary");
        scSum.textContent = "System Context";
        scDetails.appendChild(scSum);
        const scPre = document.createElement("pre");
        scPre.textContent = systemContext;
        scDetails.appendChild(scPre);
        metaContainer.appendChild(scDetails);
      }

      if(fullHistory) {
        const fhDetails = document.createElement("details");
        const fhSum = document.createElement("summary");
        fhSum.textContent = "Full History";
        fhDetails.appendChild(fhSum);
        const fhPre = document.createElement("pre");
        fhPre.textContent = JSON.stringify(fullHistory, null, 2);
        fhDetails.appendChild(fhPre);
        metaContainer.appendChild(fhDetails);
      }

      const directDetails = document.createElement("details");
      const ddSum = document.createElement("summary");
      ddSum.textContent = "Direct Link";
      directDetails.appendChild(ddSum);
      const ddSpan = document.createElement("span");
      ddSpan.textContent = `/pair/${pairId}`;
      directDetails.appendChild(ddSpan);
      metaContainer.appendChild(directDetails);

      seqDiv.appendChild(metaContainer);
    }

    chatMessagesEl.appendChild(seqDiv);
    chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;
  }

  /* ------------------------------------------------------------------
   * Get and render entire chat history for a tab
   * ------------------------------------------------------------------ */
  async function loadChatHistory(tabId = 1) {
    chatMessagesEl.innerHTML="";
    try {
      const pairs = await fetch(`/api/chat/history?tabId=${tabId}`).then(r => r.json());
      for (const p of pairs) {
        const pairDetail = await fetch(`/pair/${p.id}`).then(r=>r.json());
        p._history = pairDetail;
        addChatMessage(
                p.id,
                p.user_text,
                p.timestamp,
                p.ai_text,
                p.ai_timestamp,
                p.model,
                p.system_context,
                p._history
        );
      }
    } catch (err) {
      console.error("Error loading chat history:", err);
    }
  }

  /* ------------------------------------------------------------------
   * Chat input + streaming
   * ------------------------------------------------------------------ */
  const chatMessagesEl = document.getElementById("chatMessages");
  const chatInputEl = document.getElementById("chatInput");
  const chatSendBtnEl = document.getElementById("chatSendBtn");
  const waitingElem = document.getElementById("waitingCounter");
  const scrollDownBtnEl = document.getElementById("scrollDownBtn");

  function checkScroll() {
    const bottomOffset = chatMessagesEl.scrollHeight - chatMessagesEl.scrollTop - chatMessagesEl.clientHeight;
    if(bottomOffset > 80) {
      scrollDownBtnEl.style.display = "block";
    } else {
      scrollDownBtnEl.style.display = "none";
    }
  }
  chatMessagesEl.addEventListener("scroll", checkScroll);
  scrollDownBtnEl.addEventListener("click", ()=>{
    chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;
  });

  chatInputEl.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      chatSendBtnEl.click();
    }
  });

  chatSendBtnEl.addEventListener("click", async () => {
    const userMessage = chatInputEl.value.trim();
    if(!userMessage) return;
    const userTime = new Date().toISOString();
    chatInputEl.value = "";

    const seqDiv = document.createElement("div");
    seqDiv.className = "chat-sequence";

    /* User bubble quick placeholder */
    const userDiv = document.createElement("div");
    userDiv.className = "chat-user";
    {
      const userHead = document.createElement("div");
      userHead.className = "bubble-header";
      userHead.innerHTML = `
        <div class="name-oval name-oval-user">User</div>
        <span style="opacity:0.8;">${formatTimestamp(userTime)}</span>
      `;
      userDiv.appendChild(userHead);

      const userBody = document.createElement("div");
      userBody.textContent = userMessage;
      userDiv.appendChild(userBody);
    }
    seqDiv.appendChild(userDiv);

    /* Bot placeholder bubble */
    const botDiv = document.createElement("div");
    botDiv.className = "chat-bot";
    {
      const botHead = document.createElement("div");
      botHead.className = "bubble-header";
      botHead.innerHTML = `
        <div class="name-oval name-oval-ai">${window.agentName}</div>
        <span style="opacity:0.8;">‚Ä¶</span>
      `;
      botDiv.appendChild(botHead);

      const botBody = document.createElement("div");
      botBody.textContent = "Thinking‚Ä¶";
      botDiv.appendChild(botBody);
    }
    seqDiv.appendChild(botDiv);

    chatMessagesEl.appendChild(seqDiv);
    chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;

    let partialText = "";
    let waitTime=0;
    waitingElem.textContent = "Waiting: 0.0s";
    const waitInterval = setInterval(()=>{
      waitTime+=0.1;
      waitingElem.textContent = `Waiting: ${waitTime.toFixed(1)}s`;
    }, 100);

    try {
      const resp = await fetch("/api/chat",{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({message:userMessage, tabId: currentTabId, userTime})
      });
      clearInterval(waitInterval);
      waitingElem.textContent = "";

      if(!resp.ok){
        botDiv.querySelector("div:nth-of-type(2)").textContent = "[Error contacting AI]";
        botHead.querySelector("span").textContent = formatTimestamp(new Date().toISOString());
      } else {
        const reader = resp.body.getReader();
        while(true){
          const { value, done } = await reader.read();
          if(done) break;
          partialText += new TextDecoder().decode(value);
          botDiv.querySelector("div:nth-of-type(2)").textContent = partialText;
          chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;
        }
        botHead.querySelector("span").textContent = formatTimestamp(new Date().toISOString());
      }
      await loadChatHistory(currentTabId);
    } catch(e) {
      clearInterval(waitInterval);
      waitingElem.textContent = "";
      botDiv.querySelector("div:nth-of-type(2)").textContent = "[Error occurred]";
      botHead.querySelector("span").textContent = formatTimestamp(new Date().toISOString());
    }
    chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;
  });

  /* Chat Settings gear logic */
  $("#chatSettingsBtn").addEventListener("click", async () => {
    const r = await fetch("/api/settings/chat_hide_metadata");
    if(r.ok){
      const { value } = await r.json();
      chatHideMetadata = !!value;
    }
    $("#hideMetadataCheck").checked = chatHideMetadata;
    showModal($("#chatSettingsModal"));
  });

  $("#chatSettingsSaveBtn").addEventListener("click", async () => {
    chatHideMetadata = $("#hideMetadataCheck").checked;
    await fetch("/api/settings", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ key: "chat_hide_metadata", value: chatHideMetadata })
    });
    hideModal($("#chatSettingsModal"));
    await loadChatHistory(currentTabId);
  });

  $("#chatSettingsCancelBtn").addEventListener("click", () => {
    hideModal($("#chatSettingsModal"));
  });

  /* Draggable divider */
  (function installDividerDrag(){
    const divider = $("#divider");
    let isDragging = false;
    let startX = 0;
    let startWidth = 0;

    divider.addEventListener("mousedown", e => {
      e.preventDefault();
      isDragging = true;
      startX = e.clientX;
      startWidth = $(".sidebar").offsetWidth;
      document.body.style.userSelect = "none";
    });

    document.addEventListener("mousemove", e => {
      if(!isDragging) return;
      const dx = e.clientX - startX;
      const newWidth = startWidth + dx;
      const minWidth = 150;
      if(newWidth >= minWidth) {
        $(".sidebar").style.width = newWidth + "px";
      }
    });

    document.addEventListener("mouseup", () => {
      isDragging = false;
      document.body.style.userSelect = "";
    });
  })();

  (async function init(){
    await loadSettings();
    await populateFilters();
    await loadTasks();
    try {
      const r = await fetch("/api/model");
      if(r.ok){
        const data = await r.json();
        modelName = data.model || "unknown";
      }
    } catch(e){
      modelName = "unknown";
    }
    $("#modelHud").textContent = "Model: " + modelName;

    await loadTabs();
    if(chatTabs.length>0){
      currentTabId = chatTabs[0].id;
    } else {
      await fetch("/api/chat/tabs/new", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ name: "Main" })
      });
      await loadTabs();
      currentTabId = chatTabs[0].id;
    }
    renderTabs();
    await loadChatHistory(currentTabId);

    try {
      const r2 = await fetch("/api/settings/agent_instructions");
      if(r2.ok){
        const { value } = await r2.json();
        $("#displayedInstructions").textContent = value || "(none)";
        window.agentInstructions = value || "";
      }
    } catch(e){
      console.error("Error loading agent instructions:", e);
      window.agentInstructions = "";
    }

    try {
      const r4 = await fetch("/api/settings/agent_name");
      if(r4.ok){
        const { value } = await r4.json();
        window.agentName = value || "Alfe";  // changed default to "Alfe"
      }
    } catch(e){
      window.agentName = "Alfe";            // changed default to "Alfe"
    }

    try {
      const r3 = await fetch("/api/settings/chat_hide_metadata");
      if(r3.ok){
        const { value } = await r3.json();
        chatHideMetadata = !!value;
      }
    } catch(e) {
      console.error("Error loading chat_hide_metadata:", e);
    }
  })();
</script>
</body>
</html>