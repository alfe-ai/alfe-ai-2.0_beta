<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Alfe AI</title>
  <link id="themeStylesheet" rel="stylesheet" href="nexum.css" />
  <link
          id="favicon"
          rel="icon"
          type="image/x-icon"
          href="alfe_favicon_clean_64x64.ico"
  />
</head>
<body>
  <div class="app">
    <img id="sidebarToggle" class="sidebar-toggle-icon" src="alfe_favicon_clean_64x64.ico" alt="Toggle sidebar" title="Toggle sidebar"/>
    <span id="logoText" style="position:absolute; top:12px; left:60px; font-size:1.4rem; color:var(--text-color);">Alfe AI</span>
    <aside id="sidebar">
      <div id="tabsList" style="position:relative; top: 40px;"></div>
      <button id="newTabBtn" style="position:relative; top: 40px;">New Tab</button>
    </aside>
    <main>
      <div id="viewTabsBar" style="display:flex;gap:0.5rem;margin-bottom:0.5rem;align-items:center;">
        <button id="viewTabChat" class="view-tab active" style="position:relative; left: 40px;">üí¨ Chat</button>
        <button id="viewTabTasks" class="view-tab" style="position:relative; left: 40px;">‚òëÔ∏è Tasks</button>
        <button id="viewTabArchive" class="view-tab" style="position:relative; left: 40px;" hidden>Archive</button>
        <button id="settingsBtn" title="Settings" style="margin-left:auto;background:none;border:none;color:#ddd;font-size:1.2rem;cursor:pointer;">&#9881;</button>
      </div>
<!--      <h1>Nexum Chat</h1>-->
      <div id="modelInfo" style="margin-bottom:0.5rem; color:#aaa;"></div>
      <div id="chatPanel">
        <div id="suggestions"></div>
        <div id="chat"></div>
        <div id="inputArea">
          <div id="promptWrapper" style="position:relative;display:inline-block;">
            <textarea id="prompt" rows="12" placeholder="Enter your message" style="width:600px;"></textarea>
            <div id="taskBtns">
              <button id="askBtn" style="display:none;">Ask</button>
              <button id="codeBtn" style="display:none;">Code</button>
              <button id="renderBtn" style="display:none;">Render</button>
            </div>
          </div>
          <button id="sendBtn"><span id="sendBtnText">Chat</span></button>
        </div>
      </div>
      <div id="taskListPanel" style="display:none;">
        <h2 style="margin:0;font-size:1.1rem;">Tasks</h2>
        <table id="tasks">
          <thead><tr id="headerRow"></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </main>
  </div>
  <div id="settingsModal">
    <div class="modal-content">
      <h3>Nexum Settings</h3>
      <div>
        <h4>Nexum Feature Flags</h4>
        <!-- Chat and task tabs are now always visible -->
        <label><input type="checkbox" id="flagShowDependencies"> Show "Depends On" Column</label>
        <label style="margin-left:0.5rem;"><input type="checkbox" id="flagShowArchived"> Show Archived Chats</label>
      </div>
      <div style="margin-top:0.5rem;">
        <label>Color:
          <select id="themeColorSelect">
            <option value="purple">Purple</option>
            <option value="lightblue">Light Blue</option>
            <option value="red">Red</option>
            <option value="green">Green</option>
            <option value="orange">Orange</option>
            <option value="teal">Teal</option>
            <option value="pink">Pink</option>
          </select>
        </label>
        <label style="margin-left:0.5rem;">Mode:
          <select id="themeModeSelect">
            <option value="dark">Dark</option>
            <option value="light">Light</option>
          </select>
        </label>
      </div>
      <button id="closeSettingsBtn" style="margin-top:1rem;">Close</button>
    </div>
  </div>
  <div id="tabConfigModal">
    <div class="modal-content">
      <h3>Tab Configuration</h3>
      <label>Project Name:<br/>
        <input type="text" id="tabProjectInput" style="width:100%;" />
      </label>
      <label style="margin-top:8px;">Git Repo SSH URL:<br/>
        <input type="text" id="tabRepoInput" style="width:100%;" />
      </label>
      <label style="margin-top:8px;">Tab Type:<br/>
        <select id="tabTypeSelect" style="width:100%;">
          <option value="chat">Chat</option>
          <option value="task">Task</option>
        </select>
      </label>
      <div style="margin-top:1rem;text-align:right;">
        <button id="tabConfigSaveBtn">Save</button>
        <button id="tabConfigCancelBtn">Cancel</button>
      </div>
    </div>
  </div>
  <div id="newTabModal" style="display:none;" class="modal">
    <div class="modal-content">
      <h3>New Tab</h3>
      <div>
        <div id="newTabTypeButtons">
          <button data-type="chat" class="start-type-btn selected">
            <div class="icon">üí¨</div>
            <div>Chat</div>
          </button>
          <button data-type="code" class="start-type-btn">
            <div class="icon">üíª</div>
            <div>Code</div>
          </button>
          <button data-type="design" class="start-type-btn">
            <div class="icon">üé®</div>
            <div>Design</div>
          </button>
        </div>
        <label style="margin-top:8px;">Project Name:<br/>
          <input type="text" id="newTabProjectInput" style="width:100%;" />
        </label>
        <div id="newTabRepoSection" style="margin-top:8px; display:none;">
          <label>Git Repo SSH URL:<br/>
            <input type="text" id="newTabRepoInput" style="width:100%;" />
          </label>
        </div>
      </div>
      <div style="margin-top:1rem;text-align:right;">
        <button id="newTabCreateBtn">Create</button>
        <button id="newTabCancelBtn">Cancel</button>
      </div>
    </div>
  </div>
  <div id="startDialog" class="modal" style="display:none;">
    <div id="splashAnim">
      <div id="splashTitle">Alfe AI:</div>
      <div id="splashYour">Your</div>
    </div>
    <div class="modal-content">
      <h3>Get Started</h3>
      <div>
        <div id="startTypeButtons">
          <button data-type="chat" class="start-type-btn selected">
            <div class="icon">üí¨</div>
            <div>Chat</div>
          </button>
          <button data-type="code" class="start-type-btn">
            <div class="icon">üíª</div>
            <div>Code</div>
          </button>
          <button data-type="design" class="start-type-btn">
            <div class="icon">üé®</div>
            <div>Design</div>
          </button>
        </div>
        <label style="margin-top:8px;">Message:<br/>
          <textarea id="startChatInput" rows="3" style="width:100%;" placeholder="Start chatting..."></textarea>
        </label>
        <div id="startRepoSection" style="margin-top:8px; display:none;">
          <label>Git Repo SSH URL:<br/>
            <input type="text" id="startRepoInput" style="width:100%;" />
          </label>
          <div style="font-size:0.9rem; margin-top:4px;">
            note: We will update to do setup with GitHub connector/other external connectors/self host git/ AND THE URL SPECIFICATION FOR MANUAL REMOTE WILL ALSO BE AN OPTION AT THIS STEP, BUT AT THIS POINT, IT IS THE ONLY OPTION
          </div>
        </div>
      </div>
      <div style="margin-top:1rem;text-align:right;">
        <button id="startDialogCreateBtn">Create</button>
      </div>
    </div>
  </div>
  <script>
    let tabs = [];
    let currentTabId = 1;
    let currentView = 'chat';
    let currentTasks = [];
    let taskSortColumn = 'priority';
    let taskSortAsc = true;
    let showDependencies = false;
    let showArchived = false;
    const taskColumns = [
      {key:'priority', label:'Prio'},
      {key:'status', label:'Status'},
      {key:'number', label:'#'},
      {key:'title', label:'Title'},
      {key:'dependencies', label:'Depends On'},
      {key:'project', label:'Project'},
      {key:'created', label:'Created'}
    ];
    const suggestions = [
      'Code a Pong Clone in JavaScript',
      'Create a basic to-do list in Python',
      'Explain how recursion works',
      'Design a responsive navbar'
    ];

    let currentColor = 'purple';
    let currentMode = 'dark';

    const splashPhrases = [
      "AI Software Engineer",
      "AI Developer",
      "AI Project Manager",
      "AI Scrum Master",
      "AI QA Tester",
      "AI UX Designer",
      "AI Data Scientist",
      "AI DevOps Engineer",
      "AI Security Analyst",
      "AI Picasso",
      "AI Van Gogh",
      "AI Monet",
      "AI CTO",
      "AI Solutions Architect"
    ];
    let splashIdx = 0;
    let splashTimer = null;

    function spawnSplashWord(){
      const container = document.getElementById('splashAnim');
      if(!container) return;
      const span = document.createElement('span');
      span.className = 'splash-word';
      span.textContent = splashPhrases[splashIdx % splashPhrases.length];
      splashIdx++;
      span.style.top = (60 + Math.random()*30) + 'vh';
      container.appendChild(span);
      span.addEventListener('animationend', () => span.remove());
      splashTimer = setTimeout(spawnSplashWord, 700);
    }

    function startSplash(){
      if(splashTimer === null) spawnSplashWord();
    }

    function stopSplash(){
      if(splashTimer !== null){
        clearTimeout(splashTimer);
        splashTimer = null;
      }
    }

    async function loadTheme(){
      try{
        const resColor = await fetch('/api/settings/nexum_theme_color');
        const resMode = await fetch('/api/settings/nexum_theme_mode');
        if(resColor.ok){
          const data = await resColor.json();
          currentColor = data.value || 'purple';
        } else { currentColor = 'purple'; }
        if(resMode.ok){
          const data = await resMode.json();
          currentMode = data.value || 'dark';
        } else { currentMode = 'dark'; }
        const selColor = document.getElementById('themeColorSelect');
        if(selColor) selColor.value = currentColor;
        const selMode = document.getElementById('themeModeSelect');
        if(selMode) selMode.value = currentMode;
        applyTheme(currentColor, currentMode);
      }catch(e){ applyTheme('purple','dark'); console.error(e); }
    }

    function applyTheme(color, mode){
      const link = document.getElementById('themeStylesheet');
      if(!link) return;
      const files = {
        purple: {dark:'nexum.css', light:'nexum_purple_light.css'},
        lightblue: {dark:'nexum_lightblue.css', light:'nexum_lightblue_light.css'},
        red: {dark:'nexum_red.css', light:'nexum_red_light.css'},
        green: {dark:'nexum_green.css', light:'nexum_green_light.css'},
        orange: {dark:'nexum_orange.css', light:'nexum_orange_light.css'},
        teal: {dark:'nexum_teal.css', light:'nexum_teal_light.css'},
        pink: {dark:'nexum_pink.css', light:'nexum_pink_light.css'}
      };
      link.href = files[color]?.[mode] || 'nexum.css';
    }
    const urlParams = new URLSearchParams(location.search);
    const startTab = parseInt(urlParams.get('tabId'), 10);
    if(!Number.isNaN(startTab)) currentTabId = startTab;


    async function loadModelInfo(){
      try{
        const res = await fetch('/api/model');
        if(!res.ok) return;
        const data = await res.json();
        document.getElementById('modelInfo').textContent = 'Model: ' + (data.model || 'unknown');
      }catch(e){console.error(e);}
    }

    async function loadTabs(){
      try{
        const res = await fetch('/api/chat/tabs?nexum=1&showArchived=' + (showArchived ? '1' : '0'));
        if(res.ok){
          tabs = await res.json();
        } else {
          tabs = [];
        }
      }catch(e){ tabs = []; console.error(e); }
    }

  function renderTabs(){
    const container = document.getElementById('tabsList');
    container.innerHTML = '';
    tabs.forEach(t => {
        const item = document.createElement('div');
        item.className = 'tab-item';

        const b = document.createElement('button');
        const icon = document.createElement('span');
        icon.className = 'type-icon';
        icon.textContent = t.tab_type === 'task' ? '</>' : 'üí¨';
        b.appendChild(document.createTextNode(t.name));
        b.appendChild(icon);
        if(t.id === currentTabId) b.classList.add('active');
        b.addEventListener('click', () => {
          currentTabId = t.id;
          applyTabView();
          renderTabs();
        });
        b.addEventListener('contextmenu', e => {
          e.preventDefault();
          const choice = prompt("Type 'rename' or 'delete':", "");
          if(choice === 'rename') renameTab(t.id);
          else if(choice === 'delete') deleteTab(t.id);
        });

        const gear = document.createElement('button');
        gear.innerHTML = '&#9881;';
        gear.className = 'config-btn';
        gear.addEventListener('click', (e) => { e.stopPropagation(); openTabConfig(t.id); });

        const archBtn = document.createElement('button');
        archBtn.innerHTML = t.archived ? 'Unarchive' : '&#128452;';
        archBtn.title = t.archived ? 'Unarchive' : 'Archive';
        archBtn.className = 'config-btn';
        archBtn.addEventListener('click', e => {
          e.stopPropagation();
          toggleArchiveTab(t.id, !t.archived);
        });

        item.appendChild(b);
        item.appendChild(gear);
      item.appendChild(archBtn);
      container.appendChild(item);
    });
    checkNoTabsDialog();
  }

  function checkNoTabsDialog(){
    const dlg = document.getElementById('startDialog');
    if(!dlg) return;
    const noTabs = tabs.length === 0;
    dlg.style.display = noTabs ? 'flex' : 'none';
    if(noTabs){
      handleStartTypeChange();
      startSplash();
    } else {
      stopSplash();
    }
    const chatPanel = document.getElementById('chatPanel');
    if(chatPanel) chatPanel.style.display = noTabs ? 'none' : '';
    const taskPanel = document.getElementById('taskListPanel');
    if(taskPanel) taskPanel.style.display = noTabs ? 'none' : (currentView === 'tasks' ? '' : 'none');
  }

    function isoDate(d){
      return new Date(d).toLocaleDateString([], {year:'2-digit',month:'2-digit',day:'2-digit'});
    }

    function sortTasks(){
      if(!showDependencies && taskSortColumn === 'dependencies'){
        taskSortColumn = 'priority';
      }
      currentTasks.sort((a,b)=>{
        let va = a[taskSortColumn];
        let vb = b[taskSortColumn];
        if(taskSortColumn === 'created'){
          va = new Date(a.created_at);
          vb = new Date(b.created_at);
        }
        if(typeof va === 'string') va = va.toLowerCase();
        if(typeof vb === 'string') vb = vb.toLowerCase();
        if(va < vb) return taskSortAsc ? -1 : 1;
        if(va > vb) return taskSortAsc ? 1 : -1;
        return 0;
      });
    }

    function renderTaskHeader(){
      const tr = document.getElementById('headerRow');
      if(!tr) return;
      tr.innerHTML = '';
      taskColumns.forEach(col => {
        if(!showDependencies && col.key === 'dependencies') return;
        const th = document.createElement('th');
        th.textContent = col.label;
        th.dataset.key = col.key;
        th.style.cursor = 'pointer';
        if(taskSortColumn === col.key) th.textContent += taskSortAsc ? ' \u25B2' : ' \u25BC';
        th.addEventListener('click', () => {
          if(taskSortColumn === col.key){
            taskSortAsc = !taskSortAsc;
          } else {
            taskSortColumn = col.key;
            taskSortAsc = true;
          }
          sortTasks();
          renderTaskHeader();
          renderTasks(currentTasks);
        });
        tr.appendChild(th);
      });
    }

    function renderTasks(tasks){
      const tbody = document.querySelector('#tasks tbody');
      if(!tbody) return;
      tbody.innerHTML = '';
      tasks.forEach(t => {
        const tr = document.createElement('tr');
        taskColumns.forEach(col => {
          if(!showDependencies && col.key === 'dependencies') return;
          const td = document.createElement('td');
          switch(col.key){
            case 'number':
              td.innerHTML = `<a href="${t.html_url}" target="_blank">#${t.number}</a>`;
              break;
            case 'created':
              td.textContent = isoDate(t.created_at);
              break;
            default:
              td.textContent = t[col.key] || '';
          }
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
    }

    async function loadTasksForCurrentProject(){
      const t = tabs.find(tt => tt.id === currentTabId);
      let url;
      if(!t || !t.project_name){
        url = '/api/tasks';
      }else{
        url = '/api/projects/' + encodeURIComponent(t.project_name);
      }
      try{
        const res = await fetch(url);
        if(res.ok){
          currentTasks = await res.json();
          sortTasks();
          renderTaskHeader();
          renderTasks(currentTasks);
        }else{
          currentTasks = [];
          renderTasks([]);
        }
      }catch(e){
        console.error(e);
        currentTasks = [];
        renderTasks([]);
      }
    }

    function renderSuggestions(show = true){
      const container = document.getElementById('suggestions');
      if(!container) return;
      container.innerHTML = '';
      container.style.display = show ? 'grid' : 'none';
      if(!show) return;
      suggestions.forEach(text => {
        const b = document.createElement('button');
        b.textContent = text;
        b.addEventListener('click', () => {
          document.getElementById('prompt').value = text;
          document.getElementById('prompt').focus();
        });
        container.appendChild(b);
      });
    }

    async function loadHistory(){
      try{
        const res = await fetch(`/api/chat/history?tabId=${currentTabId}&limit=20&offset=0`);
        if(!res.ok) return;
        const data = await res.json();
        const chatDiv = document.getElementById('chat');
        chatDiv.innerHTML = '';
        (data.pairs || []).reverse().forEach(p => {
          addMsg('user', p.user_text);
          if(p.ai_text) addMsg('ai', p.ai_text);
        });
        chatDiv.scrollTop = chatDiv.scrollHeight;
        renderSuggestions((data.pairs || []).length === 0);
      }catch(e){console.error(e);}
    }
    function addMsg(role,text){
      const el=document.createElement('div');
      el.className='msg '+(role==='user'?'user':'ai');
      el.textContent=text;
      document.getElementById('chat').appendChild(el);
    }
    let newTabSelectedType = 'chat';

    function handleNewTabTypeChange(){
      const section = document.getElementById('newTabRepoSection');
      if(section) section.style.display = newTabSelectedType === 'code' ? '' : 'none';
    }

    function openNewTabModal(){
      document.getElementById('newTabProjectInput').value = '';
      document.getElementById('newTabRepoInput').value = '';
      newTabSelectedType = 'chat';
      document.querySelectorAll('#newTabTypeButtons .start-type-btn').forEach(b => b.classList.remove('selected'));
      const chatBtn = document.querySelector('#newTabTypeButtons .start-type-btn[data-type="chat"]');
      if(chatBtn) chatBtn.classList.add('selected');
      handleNewTabTypeChange();
      document.getElementById('newTabModal').style.display = 'flex';
    }

    async function createNewTab(){
      const type = newTabSelectedType;
      const project = document.getElementById('newTabProjectInput').value.trim();
      const repo = document.getElementById('newTabRepoInput').value.trim();
      const name = project || 'New Tab';
      const body = { name, nexum:1, type, project, repo };
      const r = await fetch('/api/chat/tabs/new',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
      if(r.ok){
        document.getElementById('newTabModal').style.display = 'none';
        await loadTabs();
        if(tabs.length>0){
          currentTabId = tabs[tabs.length-1].id;
          openTabConfig(currentTabId);
        }
        renderTabs();
        applyTabView();
      }
    }

    let startSelectedType = 'chat';

    async function createStartTab(){
      const type = startSelectedType;
      const message = document.getElementById('startChatInput').value.trim();
      const repo = document.getElementById('startRepoInput').value.trim();
      const body = { name:'New Tab', nexum:1, type, project:'', repo };
      const r = await fetch('/api/chat/tabs/new',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
      if(r.ok){
        const data = await r.json();
        document.getElementById('startDialog').style.display = 'none';
        stopSplash();
        await loadTabs();
        currentTabId = data.id;
        renderTabs();
        if(message){
          // Propagate the user's start dialog message to the new chat tab
          document.getElementById('prompt').value = message;
          await send();
        }
        applyTabView();
      }
    }

    function handleStartTypeChange(){
      const section = document.getElementById('startRepoSection');
      if(section) section.style.display = startSelectedType === 'code' ? '' : 'none';
    }
    async function renameTab(tabId){
      const t = tabs.find(tt => tt.id === tabId);
      const newName = prompt("New name:", t ? t.name : "");
      if(!newName) return;
      try{
        const r = await fetch("/api/chat/tabs/rename",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({tabId,newName})});
        if(r.ok){
          await loadTabs();
          renderTabs();
        }
      }catch(e){console.error(e);}
    }

    async function deleteTab(tabId){
      if(!confirm('Are you sure you want to delete this tab (and all its messages)?')) return;
      try{
        const r = await fetch('/api/chat/tabs/' + tabId,{method:'DELETE'});
        if(r.ok){
          await loadTabs();
          if(tabs.length>0){
            currentTabId = tabs[0].id;
          }else{
            currentTabId = 1;
          }
          renderTabs();
          if(currentView === 'chat') loadHistory();
          if(currentView === 'tasks') loadTasksForCurrentProject();
        }
      }catch(e){console.error(e);}
    }

    async function toggleArchiveTab(tabId, archived){
      try{
        const r = await fetch('/api/chat/tabs/archive',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({tabId, archived})});
        if(r.ok){
          await loadTabs();
          renderTabs();
          if(currentView === 'chat') loadHistory();
          if(currentView === 'tasks') loadTasksForCurrentProject();
        }
      }catch(e){console.error(e);}
    }

    function openTabConfig(tabId){
      const t = tabs.find(tt => tt.id === tabId) || {};
      document.getElementById('tabProjectInput').value = t.project_name || '';
      document.getElementById('tabRepoInput').value = t.repo_ssh_url || '';
      document.getElementById('tabTypeSelect').value = t.tab_type || 'chat';
      const modal = document.getElementById('tabConfigModal');
      modal.dataset.tabId = tabId;
      modal.style.display = 'flex';
    }

    function updateView(v){
      currentView = v;
      document.getElementById('viewTabChat').classList.toggle('active', v === 'chat');
      document.getElementById('viewTabTasks').classList.toggle('active', v === 'tasks');
      document.getElementById('viewTabArchive').classList.toggle('active', v === 'archive');

      const sendBtn = document.getElementById('sendBtn');
      const askBtn = document.getElementById('askBtn');
      const renderBtn = document.getElementById('renderBtn');
      const codeBtn = document.getElementById('codeBtn');
      if(sendBtn && askBtn && renderBtn && codeBtn){
        const t = tabs.find(tt => tt.id === currentTabId) || {};
        const type = t.tab_type || 'chat';
        const hasRepo = !!(t.repo_ssh_url && t.repo_ssh_url.trim());
        const isCode = type === 'code';
        if(v === 'chat'){
          sendBtn.style.display = '';
          renderBtn.style.display = '';
          askBtn.style.display = isCode ? '' : 'none';
          codeBtn.style.display = isCode && hasRepo ? '' : 'none';
        } else {
          sendBtn.style.display = 'none';
          renderBtn.style.display = '';
          askBtn.style.display = isCode ? '' : 'none';
          codeBtn.style.display = isCode && hasRepo ? '' : 'none';
        }
      }

      const taskPanel = document.getElementById('taskListPanel');
      if(taskPanel) taskPanel.style.display = v === 'tasks' ? '' : 'none';

      const chatEl = document.getElementById('chat');
      if(chatEl) chatEl.style.display = v === 'tasks' ? 'none' : '';
      const suggestionsEl = document.getElementById('suggestions');
      if(suggestionsEl) suggestionsEl.style.display = v === 'tasks' ? 'none' : '';

      const chatPanel = document.getElementById('chatPanel');
      if(chatPanel){
        chatPanel.classList.toggle('tasks-view', v === 'tasks');
        chatPanel.style.display = '';
      }

      if(v === 'chat') {
        loadHistory();
      }
      if(v === 'tasks') {
        renderTaskHeader();
        loadTasksForCurrentProject();
      }
    }

    function applyTabView(){
      if(tabs.length === 0){
        const chatPanel = document.getElementById('chatPanel');
        if(chatPanel) chatPanel.style.display = 'none';
        const taskPanel = document.getElementById('taskListPanel');
        if(taskPanel) taskPanel.style.display = 'none';
        return;
      }
      const t = tabs.find(tt => tt.id === currentTabId);
      const isTask = t && t.tab_type === 'task';
      updateView(isTask ? 'tasks' : 'chat');
    }


    async function send(){
      const promptEl=document.getElementById('prompt');
      const text=promptEl.value.trim();
      if(!text) return;
      renderSuggestions(false);
      addMsg('user',text);
      promptEl.value='';
      const aiEl=document.createElement('div');
      aiEl.className='msg ai';
      aiEl.textContent='...';
      document.getElementById('chat').appendChild(aiEl);
      document.getElementById('chat').scrollTop=document.getElementById('chat').scrollHeight;
      try{
        const resp=await fetch('/api/chat',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({message:text,tabId:currentTabId})});
        if(!resp.ok||!resp.body){aiEl.textContent='[error]';return;}
        const reader=resp.body.getReader();
        const dec=new TextDecoder();
        let done=false;let result='';
        while(!done){
          const {value,done:doneR}=await reader.read();
          done=doneR;
          if(value){result+=dec.decode(value);aiEl.textContent=result;document.getElementById('chat').scrollTop=document.getElementById('chat').scrollHeight;}
        }
      }catch(e){aiEl.textContent='[error]';console.error(e);}
    }
    async function createTask(){
      const promptEl=document.getElementById('prompt');
      const text=promptEl.value.trim();
      if(!text) return;
      const tab=tabs.find(tt=>tt.id===currentTabId) || {};
      const project=tab.project_name || '';
      promptEl.value='';
      try{
        await fetch('/api/tasks/new',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({title:text, project})});
        await loadTasksForCurrentProject();
      }catch(e){console.error(e);}
    }

    async function generateImage(){
      const promptEl=document.getElementById('prompt');
      const text=promptEl.value.trim();
      if(!text) return;
      addMsg('user', text);
      promptEl.value='';
      const aiEl=document.createElement('div');
      aiEl.className='msg ai';
      aiEl.textContent='...';
      document.getElementById('chat').appendChild(aiEl);
      document.getElementById('chat').scrollTop=document.getElementById('chat').scrollHeight;
      try{
        const resp=await fetch('/api/image/generate',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({prompt:text, tabId:currentTabId})});
        const data=await resp.json();
        if(resp.ok && data.url){
          aiEl.textContent='';
          const img=document.createElement('img');
          img.src=data.url;
          img.alt=text;
          img.style.maxWidth='100%';
          aiEl.appendChild(img);
        }else{
          aiEl.textContent=data.error||'[error]';
        }
      }catch(e){
        aiEl.textContent='[error]';
        console.error(e);
      }
    }
    document.getElementById('sendBtn').addEventListener('click',send);
    document.getElementById('askBtn').addEventListener('click',send);
    document.getElementById('codeBtn').addEventListener('click',createTask);
    document.getElementById('renderBtn').addEventListener('click',generateImage);
    document.getElementById('prompt').addEventListener('keydown',e=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();send();}});
    document.getElementById('newTabBtn').addEventListener('click', openNewTabModal);
    document.getElementById('newTabCreateBtn').addEventListener('click', createNewTab);
    document.getElementById('newTabCancelBtn').addEventListener('click', () => {
      document.getElementById('newTabModal').style.display = 'none';
    });
    document.getElementById('newTabModal').addEventListener('click', e => {
      if(e.target === e.currentTarget) e.currentTarget.style.display = 'none';
    });
    document.querySelectorAll('#newTabTypeButtons .start-type-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        newTabSelectedType = btn.dataset.type;
        document.querySelectorAll('#newTabTypeButtons .start-type-btn').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
        handleNewTabTypeChange();
      });
    });
    document.getElementById('startDialogCloseBtn').addEventListener('click', () => {
      document.getElementById('startDialog').style.display = 'none';
      stopSplash();
    });
    document.querySelectorAll('#startTypeButtons .start-type-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        startSelectedType = btn.dataset.type;
        document.querySelectorAll('#startTypeButtons .start-type-btn').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
        handleStartTypeChange();
      });
    });
    document.getElementById('startDialogCreateBtn').addEventListener('click', createStartTab);
    document.getElementById('startDialog').addEventListener('click', e => {
      if(e.target === e.currentTarget) {
        e.currentTarget.style.display = 'none';
        stopSplash();
      }
    });
    document.getElementById('viewTabChat').addEventListener('click', () => updateView('chat'));
    document.getElementById('viewTabTasks').addEventListener('click', () => updateView('tasks'));
    document.getElementById('viewTabArchive').addEventListener('click', () => updateView('archive'));

    function applyFeatureFlags(){
      const chatBtn = document.getElementById('viewTabChat');
      if(chatBtn) chatBtn.style.display = '';
      showDependencies = localStorage.getItem('flagShowDependencies') === 'true';
      showArchived = localStorage.getItem('flagShowArchived') === 'true';
      const cbDeps = document.getElementById('flagShowDependencies');
      if(cbDeps) cbDeps.checked = showDependencies;
      const cbArch = document.getElementById('flagShowArchived');
      if(cbArch) cbArch.checked = showArchived;
      if(currentView === 'tasks'){
        renderTaskHeader();
        renderTasks(currentTasks);
      }
    }

    document.getElementById('flagShowDependencies').addEventListener('change', e => {
      localStorage.setItem('flagShowDependencies', e.target.checked);
      applyFeatureFlags();
    });

    document.getElementById('flagShowArchived').addEventListener('change', e => {
      localStorage.setItem('flagShowArchived', e.target.checked);
      applyFeatureFlags();
      loadTabs().then(renderTabs);
    });

    document.getElementById('themeColorSelect').addEventListener('change', async e => {
      currentColor = e.target.value;
      applyTheme(currentColor, currentMode);
      await fetch('/api/settings', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({key:'nexum_theme_color', value: currentColor})});
    });
    document.getElementById('themeModeSelect').addEventListener('change', async e => {
      currentMode = e.target.value;
      applyTheme(currentColor, currentMode);
      await fetch('/api/settings', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({key:'nexum_theme_mode', value: currentMode})});
    });

    document.getElementById('settingsBtn').addEventListener('click', () => {
      document.getElementById('settingsModal').style.display = 'flex';
    });
    document.getElementById('closeSettingsBtn').addEventListener('click', () => {
      document.getElementById('settingsModal').style.display = 'none';
    });
    document.getElementById('settingsModal').addEventListener('click', e => {
      if(e.target === e.currentTarget) e.currentTarget.style.display = 'none';
    });

    document.getElementById('tabConfigSaveBtn').addEventListener('click', async () => {
      const modal = document.getElementById('tabConfigModal');
      const tabId = parseInt(modal.dataset.tabId, 10);
      const project = document.getElementById('tabProjectInput').value;
      const repo = document.getElementById('tabRepoInput').value;
      const type = document.getElementById('tabTypeSelect').value;
      await fetch('/api/chat/tabs/config', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({tabId, project, repo, type})});
      modal.style.display = 'none';
      await loadTabs();
      renderTabs();
      applyTabView();
      if(currentView === 'tasks') loadTasksForCurrentProject();
    });
    document.getElementById('tabConfigCancelBtn').addEventListener('click', () => {
      document.getElementById('tabConfigModal').style.display = 'none';
    });
    document.getElementById('tabConfigModal').addEventListener('click', e => {
      if(e.target === e.currentTarget) e.currentTarget.style.display = 'none';
    });

    async function init(){
      loadModelInfo();
      await loadTheme();
      applyFeatureFlags();
      await loadTabs();
      if(tabs.length>0){
        if(!Number.isNaN(startTab) && tabs.some(t=>t.id===startTab)){
          currentTabId = startTab;
        }else{
          currentTabId = tabs[0].id;
        }
      }
      renderTabs();
      renderSuggestions(false); // show/hide after history loads
      applyTabView();
    }
    init();

    document.getElementById('sidebarToggle').addEventListener('click', () => {
      const sb = document.getElementById('sidebar');
      if(sb.style.display === 'none') sb.style.display = '';
      else sb.style.display = 'none';
    });
  </script>
</body>
</html>
